// Generated by purs version 0.15.4
import * as $foreign from "./foreign.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Apply from "../Control.Apply/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_Error_Class from "../Control.Monad.Error.Class/index.js";
import * as Control_Monad_Trans_Class from "../Control.Monad.Trans.Class/index.js";
import * as Control_Monad_Writer_Trans from "../Control.Monad.Writer.Trans/index.js";
import * as Data_Argonaut_Decode_Class from "../Data.Argonaut.Decode.Class/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Bifunctor from "../Data.Bifunctor/index.js";
import * as Data_Either from "../Data.Either/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Function from "../Data.Function/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_HeytingAlgebra from "../Data.HeytingAlgebra/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Monoid from "../Data.Monoid/index.js";
import * as Data_Newtype from "../Data.Newtype/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Set from "../Data.Set/index.js";
import * as Data_String_CodePoints from "../Data.String.CodePoints/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Data_String_Regex from "../Data.String.Regex/index.js";
import * as Data_String_Regex_Flags from "../Data.String.Regex.Flags/index.js";
import * as Data_String_Regex_Unsafe from "../Data.String.Regex.Unsafe/index.js";
import * as Data_Traversable from "../Data.Traversable/index.js";
import * as Data_Unfoldable from "../Data.Unfoldable/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Dodo from "../Dodo/index.js";
import * as Effect_Unsafe from "../Effect.Unsafe/index.js";
import * as Node_Path from "../Node.Path/index.js";
import * as Parsing from "../Parsing/index.js";
import * as Parsing_String from "../Parsing.String/index.js";
import * as Parsing_String_Replace from "../Parsing.String.Replace/index.js";
import * as PureScript_CST from "../PureScript.CST/index.js";
import * as Safe_Coerce from "../Safe.Coerce/index.js";
import * as Tidy from "../Tidy/index.js";
import * as TsBridgeGen_Core from "../TsBridgeGen.Core/index.js";
import * as TsBridgeGen_Monad from "../TsBridgeGen.Monad/index.js";
import * as TsBridgeGen_Print from "../TsBridgeGen.Print/index.js";
import * as TsBridgeGen_Types from "../TsBridgeGen.Types/index.js";
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var defaultFormatOptions = /* #__PURE__ */ Tidy.defaultFormatOptions(Tidy.formatErrorVoid);
var unwrap = /* #__PURE__ */ Data_Newtype.unwrap();
var bind = /* #__PURE__ */ Control_Bind.bind(Data_Maybe.bindMaybe);
var $$try = /* #__PURE__ */ Control_Monad_Error_Class["try"](Control_Monad_Error_Class.monadErrorEffect);
var bind1 = /* #__PURE__ */ Control_Bind.bind(Parsing.bindParserT);
var mapFlipped = /* #__PURE__ */ Data_Functor.mapFlipped(Parsing.functorParserT);
var lmap = /* #__PURE__ */ Data_Bifunctor.lmap(Data_Bifunctor.bifunctorTuple);
var lmap1 = /* #__PURE__ */ Data_Bifunctor.lmap(Data_Bifunctor.bifunctorEither);
var mempty = /* #__PURE__ */ Data_Monoid.mempty(TsBridgeGen_Types.monoidSourcePosition);
var lift = /* #__PURE__ */ Control_Monad_Trans_Class.lift(Parsing.monadTransParserT);
var pure = /* #__PURE__ */ Control_Applicative.pure(Parsing.applicativeParserT);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var mapFlipped1 = /* #__PURE__ */ Data_Functor.mapFlipped(Data_Functor.functorArray);
var bind2 = /* #__PURE__ */ Control_Bind.bind(Data_Either.bindEither);
var heytingAlgebraFunction = /* #__PURE__ */ Data_HeytingAlgebra.heytingAlgebraFunction(Data_HeytingAlgebra.heytingAlgebraBoolean);
var conj = /* #__PURE__ */ Data_HeytingAlgebra.conj(heytingAlgebraFunction);
var or = /* #__PURE__ */ Data_Foldable.or(Data_Foldable.foldableArray)(heytingAlgebraFunction);
var and = /* #__PURE__ */ Data_Foldable.and(Data_Foldable.foldableArray)(heytingAlgebraFunction);
var not = /* #__PURE__ */ Data_HeytingAlgebra.not(/* #__PURE__ */ Data_HeytingAlgebra.heytingAlgebraFunction(heytingAlgebraFunction));
var importsIsSymbol = {
    reflectSymbol: function () {
        return "imports";
    }
};
var bindWriterT = /* #__PURE__ */ Control_Monad_Writer_Trans.bindWriterT(/* #__PURE__ */ Data_Semigroup.semigroupRecord()(/* #__PURE__ */ Data_Semigroup.semigroupRecordCons(importsIsSymbol)()(Data_Semigroup.semigroupRecordNil)(/* #__PURE__ */ Data_Set.semigroupSet(TsBridgeGen_Types.ordImport))));
var monoidRecord = /* #__PURE__ */ Data_Monoid.monoidRecord()(/* #__PURE__ */ Data_Monoid.monoidRecordCons(importsIsSymbol)(/* #__PURE__ */ Data_Set.monoidSet(TsBridgeGen_Types.ordImport))()(Data_Monoid.monoidRecordNil));
var applicativeWriterT = /* #__PURE__ */ Control_Monad_Writer_Trans.applicativeWriterT(monoidRecord);
var union = /* #__PURE__ */ Data_Set.union(TsBridgeGen_Types.ordImport);
var mapFlipped2 = /* #__PURE__ */ Data_Functor.mapFlipped(Data_Maybe.functorMaybe);
var map1 = /* #__PURE__ */ Data_Set.map(TsBridgeGen_Types.ordImport);
var monadRecWriterT = /* #__PURE__ */ Control_Monad_Writer_Trans.monadRecWriterT(monoidRecord);
var monadAppWriterT = /* #__PURE__ */ TsBridgeGen_Monad.monadAppWriterT(monoidRecord);
var gDecodeJsonCons = /* #__PURE__ */ Data_Argonaut_Decode_Class.gDecodeJsonCons(/* #__PURE__ */ Data_Argonaut_Decode_Class.decodeFieldId(/* #__PURE__ */ Data_Argonaut_Decode_Class.decodeArray(TsBridgeGen_Types.decodeJsonModuleGlob)));
var decodeRecord = /* #__PURE__ */ Data_Argonaut_Decode_Class.decodeRecord(/* #__PURE__ */ gDecodeJsonCons(/* #__PURE__ */ gDecodeJsonCons(Data_Argonaut_Decode_Class.gDecodeJsonNil)({
    reflectSymbol: function () {
        return "include";
    }
})()())({
    reflectSymbol: function () {
        return "exclude";
    }
})()())();
var decodeRecord1 = /* #__PURE__ */ Data_Argonaut_Decode_Class.decodeRecord(Data_Argonaut_Decode_Class.gDecodeJsonNil)();
var coerce = /* #__PURE__ */ Safe_Coerce.coerce();
var toUnfoldable = /* #__PURE__ */ Data_Set.toUnfoldable(Data_Unfoldable.unfoldableArray);
var DhallTypeApp = /* #__PURE__ */ (function () {
    function DhallTypeApp(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    DhallTypeApp.create = function (value0) {
        return function (value1) {
            return new DhallTypeApp(value0, value1);
        };
    };
    return DhallTypeApp;
})();
var DhallTypeId = /* #__PURE__ */ (function () {
    function DhallTypeId(value0) {
        this.value0 = value0;
    };
    DhallTypeId.create = function (value0) {
        return new DhallTypeId(value0);
    };
    return DhallTypeId;
})();
var DhallExprList = /* #__PURE__ */ (function () {
    function DhallExprList(value0) {
        this.value0 = value0;
    };
    DhallExprList.create = function (value0) {
        return new DhallExprList(value0);
    };
    return DhallExprList;
})();
var DhallExprString = /* #__PURE__ */ (function () {
    function DhallExprString(value0) {
        this.value0 = value0;
    };
    DhallExprString.create = function (value0) {
        return new DhallExprString(value0);
    };
    return DhallExprString;
})();
var DhallExprTypeAnnot = /* #__PURE__ */ (function () {
    function DhallExprTypeAnnot(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    DhallExprTypeAnnot.create = function (value0) {
        return function (value1) {
            return new DhallExprTypeAnnot(value0, value1);
        };
    };
    return DhallExprTypeAnnot;
})();
var writeFileIfNotExists = function (dictMonadApp) {
    var Bind1 = ((dictMonadApp.MonadRec3()).Monad0()).Bind1();
    var bind3 = Control_Bind.bind(Bind1);
    var askAppEffects = TsBridgeGen_Monad.askAppEffects(dictMonadApp.MonadAppEffects4());
    var MonadError0 = dictMonadApp.MonadError0();
    var catchError = Control_Monad_Error_Class.catchError(MonadError0);
    var $$void = Data_Functor["void"]((Bind1.Apply0()).Functor0());
    var discard1 = discard(Bind1);
    var throwError = Control_Monad_Error_Class.throwError(MonadError0.MonadThrow0());
    return function (fallback) {
        return function (filePath) {
            return bind3(askAppEffects)(function (v) {
                return catchError($$void(v.readTextFile(filePath)))(function (v1) {
                    if (v1 instanceof TsBridgeGen_Types.ErrReadFile) {
                        return bind3(fallback)(function (content) {
                            return discard1(v.mkdirRec(Node_Path.dirname(filePath)))(function () {
                                return v.writeTextFile(filePath)(content);
                            });
                        });
                    };
                    return throwError(v1);
                });
            });
        };
    };
};
var updateFile = function (dictMonadApp) {
    var Bind1 = ((dictMonadApp.MonadRec3()).Monad0()).Bind1();
    var bind3 = Control_Bind.bind(Bind1);
    var askAppEffects = TsBridgeGen_Monad.askAppEffects(dictMonadApp.MonadAppEffects4());
    var MonadError0 = dictMonadApp.MonadError0();
    var catchError = Control_Monad_Error_Class.catchError(MonadError0);
    var applyFirst = Control_Apply.applyFirst(Bind1.Apply0());
    var log = TsBridgeGen_Monad.log(dictMonadApp.MonadLog1());
    var throwError = Control_Monad_Error_Class.throwError(MonadError0.MonadThrow0());
    var discard1 = discard(Bind1);
    return function (fallback) {
        return function (filePath) {
            return function (f) {
                return bind3(askAppEffects)(function (v) {
                    return bind3(catchError(applyFirst(v.readTextFile(filePath))(log(new TsBridgeGen_Types.LogLiteral("Patching module at " + filePath))))(function (v1) {
                        if (v1 instanceof TsBridgeGen_Types.ErrReadFile) {
                            return applyFirst(fallback)(log(new TsBridgeGen_Types.LogLiteral("Module at " + (filePath + " does not exist yet. Using a starter template."))));
                        };
                        return throwError(v1);
                    }))(function (content) {
                        return bind3(f(content))(function (content$prime) {
                            return discard1(v.mkdirRec(Node_Path.dirname(filePath)))(function () {
                                return v.writeTextFile(filePath)(content$prime);
                            });
                        });
                    });
                });
            };
        };
    };
};
var tidyPurs = function (str) {
    return (function (v) {
        if (v instanceof PureScript_CST.ParseSucceeded) {
            return new Data_Maybe.Just(Dodo.print(Dodo.plainText)(Dodo.twoSpaces)((function (v1) {
                return v1.doc;
            })(Tidy.formatModule(defaultFormatOptions)(v.value0))));
        };
        return Data_Maybe.Nothing.value;
    })(PureScript_CST.parseModule(str));
};
var sourcePosOfSection = function (txt) {
    return function (fs) {
        var regex = Data_String_Regex_Unsafe.unsafeRegex("{-GEN:" + (unwrap(fs) + "\x0a"))(Data_String_Regex_Flags.global);
        return bind(Data_String_Regex.search(regex)(txt))(TsBridgeGen_Core.indexToSourcePos(txt));
    };
};
var runPrettier = function (str) {
    return Data_Either.hush(Effect_Unsafe.unsafePerformEffect($$try($foreign.runPrettierImpl(str))));
};
var replaceComment = function (dictMonadRec) {
    return function (dictMonadApp) {
        var MonadRec3 = dictMonadApp.MonadRec3();
        var Monad0 = MonadRec3.Monad0();
        var replaceT = Parsing_String_Replace.replaceT(Monad0)(MonadRec3);
        var anyTill = Parsing_String.anyTill(Monad0);
        var MonadError0 = dictMonadApp.MonadError0();
        var catchError = Control_Monad_Error_Class.catchError(MonadError0);
        var MonadThrow0 = MonadError0.MonadThrow0();
        var liftEither = Control_Monad_Error_Class.liftEither(MonadThrow0);
        var Bind1 = Monad0.Bind1();
        var discard1 = discard(Bind1);
        var pushError = TsBridgeGen_Monad.pushError(dictMonadApp.MonadMultipleErrors2());
        var throwError = Control_Monad_Error_Class.throwError(MonadThrow0);
        var bind3 = Control_Bind.bind(Bind1);
        var pure1 = Control_Applicative.pure(Monad0.Applicative0());
        var lift1 = lift(Monad0);
        var try1 = Control_Monad_Error_Class["try"](MonadError0);
        return function (dictDecodeJson) {
            var decodeJson = Data_Argonaut_Decode_Class.decodeJson(dictDecodeJson);
            return function (path) {
                return function (v) {
                    return function (f) {
                        return function (i) {
                            return replaceT(i)(bind1(Parsing_String.string("{-GEN:" + (v + "\x0a")))(function (genStartOpen) {
                                return bind1(mapFlipped(Parsing.position)(TsBridgeGen_Core.positionToSourcePosition))(function (posJson) {
                                    return bind1(mapFlipped(anyTill(Parsing_String.string("\x0a-}\x0a")))(lmap(function (j) {
                                        return Data_Maybe.fromMaybe(j)(runPrettier(j));
                                    })))(function (v1) {
                                        return bind1(mapFlipped(Parsing.position)(TsBridgeGen_Core.positionToSourcePosition))(function (posContent) {
                                            return bind1(anyTill(Parsing_String.string("\x0a{-GEN:END-}")))(function (v2) {
                                                var getJson = catchError(liftEither(lmap1(TsBridgeGen_Types.ErrParseToJson.create)(TsBridgeGen_Core.parseToJson(v1.value0))))(function (e) {
                                                    var p = Data_Maybe.fromMaybe(mempty)((function () {
                                                        if (e instanceof TsBridgeGen_Types.ErrParseToJson && e.value0 instanceof TsBridgeGen_Types.UnexpectedTokenAtPos) {
                                                            return TsBridgeGen_Core.indexToSourcePos(v1.value0)(e.value0.value1);
                                                        };
                                                        if (e instanceof TsBridgeGen_Types.ErrParseToJson && e.value0 instanceof TsBridgeGen_Types.UnexpectedEndOfInput) {
                                                            return TsBridgeGen_Core.indexToSourcePos(v1.value0)(Data_String_CodePoints.length(v1.value0));
                                                        };
                                                        return Data_Maybe.Nothing.value;
                                                    })());
                                                    return discard1(pushError(new TsBridgeGen_Types.AtFileSection({
                                                        path: path,
                                                        section: v,
                                                        filePos: Data_Maybe.Nothing.value,
                                                        localPos: mempty
                                                    }, e)))(function () {
                                                        return throwError(e);
                                                    });
                                                });
                                                var getData = function (json) {
                                                    return catchError(liftEither(lmap1(TsBridgeGen_Types.ErrParseToData.create)(decodeJson(json))))(function (e) {
                                                        return discard1(pushError(new TsBridgeGen_Types.AtFileSection({
                                                            path: path,
                                                            section: v,
                                                            filePos: Data_Maybe.Nothing.value,
                                                            localPos: mempty
                                                        }, e)))(function () {
                                                            return throwError(e);
                                                        });
                                                    });
                                                };
                                                var getContent = function (data_) {
                                                    return catchError(f(data_)(v2.value0))(function (appError) {
                                                        return discard1(pushError(new TsBridgeGen_Types.AtFileSection({
                                                            path: path,
                                                            section: v,
                                                            filePos: Data_Maybe.Nothing.value,
                                                            localPos: mempty
                                                        }, appError)))(function () {
                                                            return throwError(appError);
                                                        });
                                                    });
                                                };
                                                var finalize = function (json) {
                                                    return function (newContent) {
                                                        return genStartOpen + (Data_String_Common.trim(json) + (v1.value1 + ("\x0a" + (newContent + ("\x0a" + v2.value1)))));
                                                    };
                                                };
                                                var getReplacement = catchError(bind3(getJson)(function (json) {
                                                    return bind3(getData(json))(function (data_) {
                                                        return bind3(getContent(data_))(function (newContent) {
                                                            return pure1(finalize(v1.value0)(newContent));
                                                        });
                                                    });
                                                }))(function (e) {
                                                    return pure1(finalize(v1.value0)(v2.value0));
                                                });
                                                return bind1(lift1(try1(getReplacement)))(Data_Either.either(Data_Function["const"](Parsing.fail("Cannot parse Json")))(pure));
                                            });
                                        });
                                    });
                                });
                            }));
                        };
                    };
                };
            };
        };
    };
};
var readAsset = function (dictMonadApp) {
    var bind3 = Control_Bind.bind(((dictMonadApp.MonadRec3()).Monad0()).Bind1());
    var askAppConfig = TsBridgeGen_Monad.askAppConfig(dictMonadApp.MonadAppConfig5());
    var askAppEffects = TsBridgeGen_Monad.askAppEffects(dictMonadApp.MonadAppEffects4());
    return function (path) {
        return bind3(askAppConfig)(function (v) {
            return bind3(askAppEffects)(function (v1) {
                return v1.readTextFile(Node_Path.concat([ v.assetsDir, path ]));
            });
        });
    };
};
var printDhallType = function (v) {
    if (v instanceof DhallTypeApp) {
        return printDhallType(v.value0) + (" " + printDhallType(v.value1));
    };
    if (v instanceof DhallTypeId) {
        return v.value0;
    };
    throw new Error("Failed pattern match at TsBridgeGen.Cli (line 374, column 18 - line 376, column 21): " + [ v.constructor.name ]);
};
var printDhallExpr = function (v) {
    if (v instanceof DhallExprList) {
        return "[\x0a" + (Data_String_Common.joinWith(",\x0a")(map(printDhallExpr)(v.value0)) + "\x0a]");
    };
    if (v instanceof DhallExprString) {
        return "\"" + (v.value0 + "\"");
    };
    if (v instanceof DhallExprTypeAnnot) {
        return printDhallExpr(v.value0) + (" : " + printDhallType(v.value1));
    };
    throw new Error("Failed pattern match at TsBridgeGen.Cli (line 368, column 18 - line 371, column 74): " + [ v.constructor.name ]);
};
var updateAllDepsFile = function (dictMonadApp) {
    var Monad0 = (dictMonadApp.MonadRec3()).Monad0();
    var bind3 = Control_Bind.bind(Monad0.Bind1());
    var askAppEffects = TsBridgeGen_Monad.askAppEffects(dictMonadApp.MonadAppEffects4());
    var pure1 = Control_Applicative.pure(Monad0.Applicative0());
    return function (v) {
        return function (v1) {
            return bind3(askAppEffects)(function (v2) {
                return bind3(v2.spagoLsDepsTransitive)(function (deps) {
                    var dhallExpr = new DhallExprTypeAnnot(new DhallExprList(mapFlipped1(deps)(function ($349) {
                        return DhallExprString.create((function (v3) {
                            return v3.packageName;
                        })($349));
                    })), new DhallTypeApp(new DhallTypeId("List"), new DhallTypeId("Text")));
                    return pure1(printDhallExpr(dhallExpr));
                });
            });
        };
    };
};
var parseStrToData = function (dictDecodeJson) {
    var decodeJson = Data_Argonaut_Decode_Class.decodeJson(dictDecodeJson);
    return function (str) {
        return bind2(lmap1(TsBridgeGen_Types.ErrParseToJson.create)(TsBridgeGen_Core.parseToJson(str)))((function () {
            var $350 = lmap1(TsBridgeGen_Types.ErrParseToData.create);
            return function ($351) {
                return $350(decodeJson($351));
            };
        })());
    };
};
var matchModuleGlob = function (v) {
    return function (v1) {
        return function (v2) {
            var replace = Data_String_Common.replaceAll(".")("/");
            return $foreign.match(replace(v))(replace(v1 + ("." + v2)));
        };
    };
};
var mapModule = function (opts) {
    return function (v) {
        var matcher = function (glob) {
            return matchModuleGlob(glob)(v.value0);
        };
        var filterName = conj(or(map(matcher)(opts.include)))(and(map(not(matcher))(opts.exclude)));
        return new TsBridgeGen_Types.PursModule(v.value0, Data_Array.filter(function ($352) {
            return filterName(TsBridgeGen_Core.getName($352));
        })(v.value1));
    };
};
var patchClassFile = function (dictMonadApp) {
    var MonadRec3 = dictMonadApp.MonadRec3();
    var Monad0 = MonadRec3.Monad0();
    var Bind1 = Monad0.Bind1();
    var bind3 = Control_Bind.bind(bindWriterT(Bind1));
    var genInstances = TsBridgeGen_Print.genInstances(Monad0);
    var Applicative0 = Monad0.Applicative0();
    var pure1 = Control_Applicative.pure(applicativeWriterT(Applicative0));
    var pure2 = Control_Applicative.pure(Applicative0);
    var bind4 = Control_Bind.bind(Bind1);
    var replaceComment1 = replaceComment(monadRecWriterT(MonadRec3))(monadAppWriterT(dictMonadApp))(decodeRecord);
    var mapFlipped3 = Data_Functor.mapFlipped((Bind1.Apply0()).Functor0());
    var replaceComment2 = replaceComment(MonadRec3)(dictMonadApp)(decodeRecord1);
    return function (path) {
        return function (defs) {
            return function (file) {
                var replaceInstances = function (opts) {
                    return function (v) {
                        return bind3(genInstances(mapFlipped1(defs)(mapModule(opts))))(function (instances) {
                            return pure1(TsBridgeGen_Print.printPursSnippets(instances));
                        });
                    };
                };
                var replaceImports = function (imports) {
                    return function (v) {
                        return function (oldImports) {
                            return pure2(TsBridgeGen_Print.printImports(union(imports)(Data_Maybe.fromMaybe(Data_Set.empty)(mapFlipped2(TsBridgeGen_Core.parseUserImports(oldImports))(map1(TsBridgeGen_Types.ImportUser.create))))));
                        };
                    };
                };
                return bind4(TsBridgeGen_Print.runImportWriterT(replaceComment1(path)("instances")(replaceInstances)(file)))(function (v) {
                    return mapFlipped3(replaceComment2(path)("imports")(replaceImports(v.value1.imports))(v.value0))(function (str) {
                        return Data_Maybe.fromMaybe(str)(tidyPurs(str));
                    });
                });
            };
        };
    };
};
var patchModulesFile = function (dictMonadApp) {
    var MonadRec3 = dictMonadApp.MonadRec3();
    var Monad0 = MonadRec3.Monad0();
    var Bind1 = Monad0.Bind1();
    var bind3 = Control_Bind.bind(bindWriterT(Bind1));
    var genTsProgram = TsBridgeGen_Print.genTsProgram(Monad0);
    var Applicative0 = Monad0.Applicative0();
    var pure1 = Control_Applicative.pure(applicativeWriterT(Applicative0));
    var pure2 = Control_Applicative.pure(Applicative0);
    var bind4 = Control_Bind.bind(Bind1);
    var replaceComment1 = replaceComment(monadRecWriterT(MonadRec3))(monadAppWriterT(dictMonadApp))(decodeRecord);
    var mapFlipped3 = Data_Functor.mapFlipped((Bind1.Apply0()).Functor0());
    var replaceComment2 = replaceComment(MonadRec3)(dictMonadApp)(decodeRecord1);
    return function (path) {
        return function (defs) {
            return function (file) {
                var replaceTsProgram = function (v) {
                    return function (v1) {
                        return bind3(genTsProgram(Data_Array.filter(function (v2) {
                            return !Data_Array["null"](v2.value1);
                        })(mapFlipped1(defs)(mapModule(v)))))(function (tsProgram) {
                            return pure1(tsProgram);
                        });
                    };
                };
                var replaceImports = function (imports) {
                    return function (v) {
                        return function (oldImports) {
                            return pure2(TsBridgeGen_Print.printImports(union(imports)(Data_Maybe.fromMaybe(Data_Set.empty)(mapFlipped2(TsBridgeGen_Core.parseUserImports(oldImports))(map1(TsBridgeGen_Types.ImportUser.create))))));
                        };
                    };
                };
                return bind4(TsBridgeGen_Print.runImportWriterT(replaceComment1(path)("ts-program")(replaceTsProgram)(file)))(function (v) {
                    return mapFlipped3(replaceComment2(path)("imports")(replaceImports(v.value1.imports))(v.value0))(function (str) {
                        return Data_Maybe.fromMaybe(str)(tidyPurs(str));
                    });
                });
            };
        };
    };
};
var getPaths = function (dictMonadApp) {
    var Bind1 = ((dictMonadApp.MonadRec3()).Monad0()).Bind1();
    var bind3 = Control_Bind.bind(Bind1);
    var askAppEffects = TsBridgeGen_Monad.askAppEffects(dictMonadApp.MonadAppEffects4());
    var mapFlipped3 = Data_Functor.mapFlipped((Bind1.Apply0()).Functor0());
    return function (globs) {
        return bind3(askAppEffects)(function (v) {
            return mapFlipped3(v.expandGlobsCwd(coerce(globs)))(toUnfoldable);
        });
    };
};
var getPursModules = function (dictMonadApp) {
    var Monad0 = (dictMonadApp.MonadRec3()).Monad0();
    var bind3 = Control_Bind.bind(Monad0.Bind1());
    var askAppEffects = TsBridgeGen_Monad.askAppEffects(dictMonadApp.MonadAppEffects4());
    var getPaths1 = getPaths(dictMonadApp);
    var Applicative0 = Monad0.Applicative0();
    var $$for = Data_Traversable["for"](Applicative0)(Data_Traversable.traversableArray);
    var liftEither = Control_Monad_Error_Class.liftEither((dictMonadApp.MonadError0()).MonadThrow0());
    var pure1 = Control_Applicative.pure(Applicative0);
    return function (globs) {
        return bind3(askAppEffects)(function (v) {
            return bind3(getPaths1(globs))(function (paths) {
                return bind3($$for(paths)(v.readTextFile))(function (sources) {
                    return bind3($$for(sources)(function ($353) {
                        return liftEither(TsBridgeGen_Core.parseCstModule($353));
                    }))(function (cstModules) {
                        return pure1(map(TsBridgeGen_Core.getPursModule)(cstModules));
                    });
                });
            });
        });
    };
};
var assets = {
    myTsBridgeClass: "MyTsBridgeClass.purs",
    myTsModules: "MyTsBridgeModules.purs",
    allDeps: "all-deps.dhall",
    packagesFile: "packages.dhall",
    spagoFile: "spago.dhall"
};
var app = function (dictMonadApp) {
    var Monad0 = (dictMonadApp.MonadRec3()).Monad0();
    var Bind1 = Monad0.Bind1();
    var bind3 = Control_Bind.bind(Bind1);
    var askAppEffects = TsBridgeGen_Monad.askAppEffects(dictMonadApp.MonadAppEffects4());
    var getPursModules1 = getPursModules(dictMonadApp);
    var discard1 = discard(Bind1);
    var updateFile1 = updateFile(dictMonadApp);
    var readAsset1 = readAsset(dictMonadApp);
    var patchClassFile1 = patchClassFile(dictMonadApp);
    var patchModulesFile1 = patchModulesFile(dictMonadApp);
    var updateAllDepsFile1 = updateAllDepsFile(dictMonadApp);
    var pure1 = Control_Applicative.pure(Monad0.Applicative0());
    var writeFileIfNotExists1 = writeFileIfNotExists(dictMonadApp);
    return bind3(TsBridgeGen_Monad.askAppConfig(dictMonadApp.MonadAppConfig5()))(function (v) {
        return bind3(askAppEffects)(function (v1) {
            return bind3(v1.spagoSources)(function (globs) {
                return bind3(getPursModules1(globs))(function (defs) {
                    return discard1(updateFile1(readAsset1(assets.myTsBridgeClass))(v.classFile)(patchClassFile1(v.classFile)(defs)))(function () {
                        return discard1(updateFile1(readAsset1(assets.myTsModules))(v.modulesFile)(patchModulesFile1(v.modulesFile)(defs)))(function () {
                            return discard1(updateFile1(readAsset1(assets.allDeps))(v.allDepsFile)(updateAllDepsFile1(v.allDepsFile)))(function () {
                                return discard1(updateFile1(readAsset1(assets.packagesFile))(v.packagesFile)(pure1))(function () {
                                    return discard1(writeFileIfNotExists1(readAsset1(assets.spagoFile))(v.spagoFile))(function () {
                                        return pure1(Data_Unit.unit);
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
    });
};
export {
    app,
    parseStrToData,
    patchClassFile,
    patchModulesFile,
    replaceComment
};
